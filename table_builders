import streamlit as st
import pandas as pd
from formatters import (
    apply_currency_formatting, apply_currency_or_empty_formatting,
    create_fy_highlighting_function, format_dataframe_index_as_string,
    format_currency, clean_numeric_for_display, apply_conditional_formatting
)

def create_pivot_income_table(financial_df, group_cols, period_col, value_col='Payment'):
    """Create a pivot table for income analysis"""
    if financial_df.empty:
        return None, None
    
    income_by_period = financial_df.groupby(group_cols)[value_col].sum().reset_index()
    if income_by_period.empty:
        return None, None
    
    pivot = income_by_period.pivot(index=period_col, columns='SiteofVisit', values=value_col).fillna(0)
    pivot['Total'] = pivot.sum(axis=1)
    
    return pivot, income_by_period

def create_financial_year_totals(financial_df, site_columns):
    """Create financial year totals for income data"""
    fy_totals = []
    for fy in sorted(financial_df['FinancialYear'].unique()):
        fy_data = financial_df[financial_df['FinancialYear'] == fy]
        fy_income_by_site = fy_data.groupby('SiteofVisit')['Payment'].sum()
        
        fy_row = {}
        for site in site_columns:
            if site == 'Total':
                fy_row[site] = fy_income_by_site.sum()
            else:
                fy_row[site] = fy_income_by_site.get(site, 0)
        
        fy_totals.append((f"FY {fy}", fy_row))
    
    return fy_totals

def display_income_table_pair(financial_df):
    """Display monthly and quarterly income tables side by side"""
    # Monthly analysis
    monthly_pivot, _ = create_pivot_income_table(
        financial_df, ['SiteofVisit', 'MonthYear'], 'MonthYear'
    )
    
    # Quarterly analysis
    quarterly_pivot, _ = create_pivot_income_table(
        financial_df, ['SiteofVisit', 'QuarterYear'], 'QuarterYear'
    )
    
    if monthly_pivot is not None and quarterly_pivot is not None:
        # Create financial year totals
        fy_monthly_totals = create_financial_year_totals(financial_df, monthly_pivot.columns)
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.write("**Monthly Income by Visit Site**")
            monthly_display = format_dataframe_index_as_string(monthly_pivot)
            monthly_display = apply_currency_formatting(monthly_display, monthly_display.columns)
            st.dataframe(monthly_display, use_container_width=True)
            
            # Financial year totals for monthly
            if fy_monthly_totals:
                st.write("**Financial Year Totals (Monthly)**")
                display_fy_totals_table(fy_monthly_totals)
        
        with col2:
            st.write("**Quarterly Income by Visit Site**")
            quarterly_display = apply_currency_formatting(quarterly_pivot, quarterly_pivot.columns)
            st.dataframe(quarterly_display, use_container_width=True)

def display_fy_totals_table(fy_totals):
    """Display financial year totals table"""
    fy_data = []
    for fy_name, fy_row in fy_totals:
        formatted_row = {"Financial Year": fy_name}
        for col, val in fy_row.items():
            formatted_row[col] = format_currency(val)
        fy_data.append(formatted_row)
    
    fy_df = pd.DataFrame(fy_data)
    st.dataframe(fy_df, use_container_width=True)

def create_styled_dataframe(df, highlight_column=None, highlight_value=None):
    """Create a styled dataframe with optional highlighting"""
    if highlight_column and highlight_value:
        style_dict = {"bg_color": "#e6f3ff", "weight": "bold"}
        return apply_conditional_formatting(df, highlight_column, highlight_value, style_dict)
    return df

def display_profit_sharing_table(quarterly_ratios):
    """Display the main profit sharing analysis table"""
    if not quarterly_ratios:
        st.warning("No quarterly data available for analysis.")
        return
    
    quarterly_df = pd.DataFrame(quarterly_ratios)
    
    # Style to highlight financial year rows
    highlight_function = create_fy_highlighting_function()
    styled_df = quarterly_df.style.apply(highlight_function, axis=1)
    
    st.write("**Quarterly Profit Sharing Analysis**")
    st.dataframe(styled_df, use_container_width=True)

def display_ratio_breakdown_table(ratio_data, title):
    """Display a ratio breakdown table"""
    if not ratio_data:
        return
    
    st.write(f"**{title}**")
    ratio_df = pd.DataFrame(ratio_data)
    st.dataframe(ratio_df, use_container_width=True)

def create_summary_metrics_row(data_dict, columns=4):
    """Create a row of metric displays"""
    cols = st.columns(columns)
    
    for i, (label, value) in enumerate(data_dict.items()):
        with cols[i % columns]:
            st.metric(label, value)

def display_breakdown_by_study(df, patient_df, site):
    """Display study breakdown for a specific site"""
    site_patients = patient_df[patient_df['Site'] == site]
    site_visits = df[df['SiteofVisit'] == site]
    
    if site_patients.empty:
        return
    
    # Study breakdown
    study_breakdown = site_patients.groupby('Study').agg({
        'PatientID': 'count'
    }).rename(columns={'PatientID': 'Patient Count'})
    
    # Add visit counts and income
    visit_breakdown = site_visits.groupby('Study').agg({
        'Visit': 'count',
        'Payment': 'sum'
    }).rename(columns={'Visit': 'Visit Count', 'Payment': 'Total Income'})
    
    # Combine data
    combined_breakdown = study_breakdown.join(visit_breakdown, how='left').fillna(0)
    combined_breakdown = apply_currency_formatting(combined_breakdown, ['Total Income'])
    
    st.dataframe(combined_breakdown, use_container_width=True)

def create_time_period_config():
    """Configuration for different time periods"""
    return {
        'monthly': {
            'column': 'MonthYear',
            'name': 'Month',
            'title': 'Monthly Ratio Breakdowns'
        },
        'quarterly': {
            'column': 'QuarterYear', 
            'name': 'Quarter',
            'title': 'Quarterly Ratio Breakdowns'
        },
        'financial_year': {
            'column': 'FinancialYear',
            'name': 'Financial Year', 
            'title': 'Financial Year Ratio Breakdowns'
        }
    }

def display_site_time_analysis(visits_df, patients_df, site, enhanced_visits_df):
    """Display time-based analysis for a specific site"""
    st.write("**Quarterly Analysis**")
    
    # Filter for financial visits only
    financial_site_visits = enhanced_visits_df[enhanced_visits_df['SiteofVisit'] == site]
    
    if not financial_site_visits.empty:
        # Quarterly stats
        quarterly_stats = financial_site_visits.groupby('QuarterYear').agg({
            'Visit': 'count',
            'Payment': 'sum'
        }).rename(columns={'Visit': 'Visit Count', 'Payment': 'Income'})
        
        # Financial year stats  
        fy_stats = financial_site_visits.groupby('FinancialYear').agg({
            'Visit': 'count',
            'Payment': 'sum'
        }).rename(columns={'Visit': 'Visit Count', 'Payment': 'Income'})
        
        if not quarterly_stats.empty:
            col1, col2 = st.columns(2)
            
            with col1:
                st.write("*Visit Counts by Quarter*")
                st.dataframe(quarterly_stats[['Visit Count']], use_container_width=True)
            
            with col2:
                quarterly_display = apply_currency_formatting(quarterly_stats[['Income']], ['Income'])
                st.write("*Income by Quarter*")
                st.dataframe(quarterly_display, use_container_width=True)
        
        st.write("**Financial Year Analysis**")
        
        if not fy_stats.empty:
            col1, col2 = st.columns(2)
            
            with col1:
                st.write("*Visit Counts by Financial Year*")
                st.dataframe(fy_stats[['Visit Count']], use_container_width=True)
            
            with col2:
                fy_display = apply_currency_formatting(fy_stats[['Income']], ['Income'])
                st.write("*Income by Financial Year*")
                st.dataframe(fy_display, use_container_width=True)

def display_site_recruitment_analysis(site_patients, enhanced_visits_df, site):
    """Display patient recruitment analysis for a site"""
    st.write("**Patient Recruitment Analysis**")
    
    # Add time period columns to patients
    site_patients_enhanced = site_patients.copy()
    site_patients_enhanced['Quarter'] = site_patients_enhanced['StartDate'].dt.quarter
    site_patients_enhanced['Year'] = site_patients_enhanced['StartDate'].dt.year
    site_patients_enhanced['QuarterYear'] = site_patients_enhanced['Year'].astype(str) + '-Q' + site_patients_enhanced['Quarter'].astype(str)
    site_patients_enhanced['FinancialYear'] = site_patients_enhanced['StartDate'].apply(
        lambda d: f"{d.year}-{d.year+1}" if d.month >= 4 else f"{d.year-1}-{d.year}"
    )
    
    # Recruitment summaries
    quarterly_recruitment = site_patients_enhanced.groupby('QuarterYear')['PatientID'].count()
    fy_recruitment = site_patients_enhanced.groupby('FinancialYear')['PatientID'].count()
    
    if not quarterly_recruitment.empty or not fy_recruitment.empty:
        col1, col2 = st.columns(2)
        
        with col1:
            if not quarterly_recruitment.empty:
                st.write("*Patients Recruited by Quarter*")
                quarterly_df = quarterly_recruitment.to_frame()
                quarterly_df.columns = ['Patients Recruited']
                st.dataframe(quarterly_df, use_container_width=True)
        
        with col2:
            if not fy_recruitment.empty:
                st.write("*Patients Recruited by Financial Year*")
                fy_df = fy_recruitment.to_frame()
                fy_df.columns = ['Patients Recruited']
                st.dataframe(fy_df, use_container_width=True)
    
    # Combined summary tables
    display_site_summary_tables(site_patients_enhanced, enhanced_visits_df, site, quarterly_recruitment, fy_recruitment)

def display_site_summary_tables(site_patients, enhanced_visits_df, site, quarterly_recruitment, fy_recruitment):
    """Display combined summary tables for a site"""
    site_enhanced_visits = enhanced_visits_df[enhanced_visits_df['SiteofVisit'] == site]
    
    # Quarterly summary
    st.write("**Quarterly Summary Table**")
    quarterly_summary = build_period_summary(
        site_enhanced_visits, quarterly_recruitment, 'QuarterYear', 'Quarter'
    )
    if quarterly_summary:
        st.dataframe(pd.DataFrame(quarterly_summary), use_container_width=True)
    
    # Financial year summary  
    st.write("**Financial Year Summary Table**")
    fy_summary = build_period_summary(
        site_enhanced_visits, fy_recruitment, 'FinancialYear', 'Financial Year'
    )
    if fy_summary:
        st.dataframe(pd.DataFrame(fy_summary), use_container_width=True)

def build_period_summary(visits_df, recruitment_series, period_col, period_name):
    """Build summary data for a time period"""
    if visits_df.empty:
        return []
    
    visit_stats = visits_df.groupby(period_col).agg({'Visit': 'count', 'Payment': 'sum'})
    all_periods = set(visit_stats.index) | set(recruitment_series.index)
    
    summary_data = []
    for period in sorted(all_periods):
        visits = visit_stats.loc[period, 'Visit'] if period in visit_stats.index else 0
        income = visit_stats.loc[period, 'Payment'] if period in visit_stats.index else 0
        patients = recruitment_series.loc[period] if period in recruitment_series.index else 0
        
        summary_data.append({
            period_name: period if period_name == 'Quarter' else period,
            'Patients Recruited': clean_numeric_for_display(patients),
            'Visits Completed': clean_numeric_for_display(visits),
            'Income': format_currency(income)
        })
    
    return summary_data

def display_site_screen_failures(site_patients, screen_failures):
    """Display screen failures for a site"""
    site_screen_failures = []
    for patient in site_patients.itertuples():
        patient_study_key = f"{patient.PatientID}_{patient.Study}"
        if patient_study_key in screen_failures:
            site_screen_failures.append({
                'Patient': patient.PatientID,
                'Study': patient.Study,
                'Screen Fail Date': screen_failures[patient_study_key].strftime('%Y-%m-%d')
            })
    
    if site_screen_failures:
        st.write("**Screen Failures**")
        st.dataframe(pd.DataFrame(site_screen_failures), use_container_width=True)

def create_excel_export_data(calendar_df, site_column_mapping, unique_sites):
    """Prepare data for Excel export with proper formatting"""
    # Get ordered columns
    final_ordered_columns = ["Date", "Day"]
    for site in unique_sites:
        site_columns = site_column_mapping.get(site, [])
        for col in site_columns:
            if col in calendar_df.columns:
                final_ordered_columns.append(col)

    # Add financial columns
    excel_financial_cols = ["Daily Total", "Monthly Total", "FY Total"] + [c for c in calendar_df.columns if "Income" in c]
    all_columns = final_ordered_columns + [col for col in excel_financial_cols if col in calendar_df.columns]
    
    excel_df = calendar_df[all_columns].copy()
    
    # Format dates and currency
    excel_df["Date"] = excel_df["Date"].dt.strftime("%d/%m/%Y")
    excel_df = apply_currency_or_empty_formatting(excel_df, ["Monthly Total", "FY Total"])
    excel_df = apply_currency_formatting(excel_df, [col for col in excel_financial_cols if col not in ["Monthly Total", "FY Total"] and col in excel_df.columns])
    
    return excel_df

def apply_excel_formatting(ws, excel_df, site_column_mapping, unique_sites):
    """Apply formatting to Excel worksheet"""
    try:
        from openpyxl.styles import PatternFill, Font, Alignment
        from openpyxl.utils import get_column_letter
        
        # Add site headers
        for col_idx, col_name in enumerate(excel_df.columns, 1):
            col_letter = get_column_letter(col_idx)
            if col_name not in ["Date", "Day"] and not any(x in col_name for x in ["Income", "Total"]):
                for site in unique_sites:
                    if col_name in site_column_mapping.get(site, []):
                        ws[f"{col_letter}1"] = site
                        ws[f"{col_letter}1"].font = Font(bold=True, size=12)
                        ws[f"{col_letter}1"].fill = PatternFill(start_color="FFE6F3FF", end_color="FFE6F3FF", fill_type="solid")
                        ws[f"{col_letter}1"].alignment = Alignment(horizontal="center")
                        break

        # Auto-adjust column widths
        for idx, col in enumerate(excel_df.columns, 1):
            col_letter = get_column_letter(idx)
            max_length = max([len(str(cell)) if cell is not None else 0 for cell in excel_df[col].tolist()] + [len(col)])
            ws.column_dimensions[col_letter].width = max(10, max_length + 2)
    except ImportError:
        # If openpyxl styles not available, skip formatting
        pass


def display_income_realization_dashboard(visits_df, trials_df, patients_df):
    """Display main income realization dashboard"""
    from calculations import calculate_income_realization_metrics
    from formatters import format_currency, format_percentage
    
    st.subheader("📊 Income Realization & Pipeline Analysis")
    
    # Calculate main metrics
    metrics = calculate_income_realization_metrics(visits_df, trials_df, patients_df)
    
    # Top-level metrics display
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "Income Realization Rate", 
            f"{metrics['realization_rate']:.1f}%",
            help="Percentage of scheduled work completed this FY"
        )
    
    with col2:
        st.metric(
            "Income Secured", 
            format_currency(metrics['completed_income']),
            help="Income from completed visits this FY"
        )
    
    with col3:
        st.metric(
            "Pipeline Value", 
            format_currency(metrics['pipeline_income']),
            help="Income from remaining scheduled visits this FY"
        )
    
    with col4:
        st.metric(
            "Total FY Potential", 
            format_currency(metrics['total_scheduled_income']),
            help="Total income possible this financial year"
        )
    
    # Performance indicator
    if metrics['realization_rate'] >= 80:
        st.success(f"✅ Strong performance: {metrics['realization_rate']:.1f}% realization rate")
    elif metrics['realization_rate'] >= 60:
        st.warning(f"⚠️ Moderate performance: {metrics['realization_rate']:.1f}% realization rate")
    else:
        st.error(f"🔴 Low performance: {metrics['realization_rate']:.1f}% realization rate")

def display_monthly_realization_breakdown(visits_df, trials_df):
    """Display month-by-month realization breakdown"""
    from calculations import calculate_monthly_realization_breakdown
    from formatters import format_currency
    
    st.write("**Monthly Realization Breakdown**")
    
    monthly_data = calculate_monthly_realization_breakdown(visits_df, trials_df)
    
    if monthly_data:
        # Format for display
        monthly_df = pd.DataFrame(monthly_data)
        monthly_df['Completed_Income_Display'] = monthly_df['Completed_Income'].apply(format_currency)
        monthly_df['Scheduled_Income_Display'] = monthly_df['Scheduled_Income'].apply(format_currency)
        monthly_df['Realization_Rate_Display'] = monthly_df['Realization_Rate'].apply(lambda x: f"{x:.1f}%")
        
        # Create display dataframe
        display_df = monthly_df[['Month', 'Completed_Income_Display', 'Scheduled_Income_Display', 
                                'Realization_Rate_Display', 'Completed_Visits', 'Scheduled_Visits']].copy()
        display_df.columns = ['Month', 'Income Secured', 'Income Scheduled', 'Realization %', 'Visits Done', 'Visits Scheduled']
        
        st.dataframe(display_df, use_container_width=True)
        
        # Show trend
        avg_realization = monthly_df['Realization_Rate'].mean()
        st.info(f"**Average Monthly Realization Rate:** {avg_realization:.1f}%")

def display_study_pipeline_ranking(visits_df, trials_df):
    """Display studies ranked by remaining pipeline value"""
    from calculations import calculate_study_pipeline_breakdown
    from formatters import format_currency
    
    st.write("**Study Pipeline Rankings**")
    st.caption("Studies ranked by remaining income potential")
    
    study_data = calculate_study_pipeline_breakdown(visits_df, trials_df)
    
    if not study_data.empty:
        # Format for display
        study_display = study_data.copy()
        study_display['Pipeline_Value_Display'] = study_display['Pipeline_Value'].apply(format_currency)
        study_display['Avg_Per_Visit'] = (study_display['Pipeline_Value'] / study_display['Remaining_Visits']).apply(format_currency)
        
        display_df = study_display[['Study', 'Pipeline_Value_Display', 'Remaining_Visits', 'Avg_Per_Visit']].copy()
        display_df.columns = ['Study', 'Pipeline Value', 'Remaining Visits', 'Avg per Visit']
        
        st.dataframe(display_df, use_container_width=True)
        
        # Summary stats
        total_pipeline = study_data['Pipeline_Value'].sum()
        st.info(f"**Total Pipeline Value:** {format_currency(total_pipeline)}")
    else:
        st.warning("No remaining pipeline visits found")

def display_site_realization_comparison(visits_df, trials_df):
    """Display site-by-site realization performance"""
    from calculations import calculate_site_realization_breakdown
    from formatters import format_currency
    
    st.write("**Site Performance Comparison**")
    
    site_data = calculate_site_realization_breakdown(visits_df, trials_df)
    
    if site_data:
        # Format for display
        site_df = pd.DataFrame(site_data)
        site_df['Completed_Income_Display'] = site_df['Completed_Income'].apply(format_currency)
        site_df['Pipeline_Income_Display'] = site_df['Pipeline_Income'].apply(format_currency)
        site_df['Realization_Rate_Display'] = site_df['Realization_Rate'].apply(lambda x: f"{x:.1f}%")
        
        # Create display table
        display_df = site_df[['Site', 'Completed_Income_Display', 'Pipeline_Income_Display', 
                             'Realization_Rate_Display', 'Completed_Visits', 'Remaining_Visits']].copy()
        display_df.columns = ['Site', 'Income Secured', 'Pipeline Value', 'Realization %', 'Visits Done', 'Visits Remaining']
        
        # Apply styling based on realization rate
        def highlight_realization(row):
            rate = float(row['Realization %'].rstrip('%'))
            if rate >= 80:
                return ['background-color: #d4edda'] * len(row)
            elif rate >= 60:
                return ['background-color: #fff3cd'] * len(row)
            else:
                return ['background-color: #f8d7da'] * len(row)
        
        styled_df = display_df.style.apply(highlight_realization, axis=1)
        st.dataframe(styled_df, use_container_width=True)
        
        # Site rankings
        best_site = site_df.loc[site_df['Realization_Rate'].idxmax()]
        highest_pipeline = site_df.loc[site_df['Pipeline_Income'].idxmax()]
        
        col1, col2 = st.columns(2)
        with col1:
            st.success(f"**Best Realization:** {best_site['Site']} ({best_site['Realization_Rate']:.1f}%)")
        with col2:
            st.info(f"**Highest Pipeline:** {highest_pipeline['Site']} ({format_currency(highest_pipeline['Pipeline_Income'])})")

def display_financial_year_summary(visits_df, trials_df, patients_df):
    """Display comprehensive financial year summary"""
    from calculations import calculate_income_realization_metrics
    from formatters import format_currency
    from datetime import date
    
    st.write("**Financial Year Summary**")
    
    metrics = calculate_income_realization_metrics(visits_df, trials_df, patients_df)
    
    # Calculate months remaining in FY
    today = pd.to_datetime(date.today())
    if today.month >= 4:
        fy_end = pd.to_datetime(f"{today.year + 1}-03-31")
    else:
        fy_end = pd.to_datetime(f"{today.year}-03-31")
    
    days_remaining = (fy_end - today).days
    months_remaining = max(0, round(days_remaining / 30.44, 1))  # Average days per month
    
    # Create summary table
    summary_data = [
        {"Metric": "Work Completion Rate", "Value": f"{(metrics['completed_visits_count'] / metrics['total_scheduled_visits_count'] * 100):.1f}%"},
        {"Metric": "Income Realization Rate", "Value": f"{metrics['realization_rate']:.1f}%"},
        {"Metric": "Income Secured", "Value": format_currency(metrics['completed_income'])},
        {"Metric": "Pipeline Remaining", "Value": format_currency(metrics['pipeline_income'])},
        {"Metric": "Months Remaining in FY", "Value": f"{months_remaining} months"},
        {"Metric": "Visits Completed", "Value": f"{metrics['completed_visits_count']:,}"},
        {"Metric": "Visits Remaining", "Value": f"{metrics['pipeline_visits_count']:,}"}
    ]
    
    summary_df = pd.DataFrame(summary_data)
    st.dataframe(summary_df, use_container_width=True, hide_index=True)
    
    # Monthly run rate needed
    if months_remaining > 0:
        monthly_target = metrics['pipeline_income'] / months_remaining
        st.info(f"**Monthly Income Target:** {format_currency(monthly_target)} needed per month to achieve full pipeline")

def display_complete_realization_analysis(visits_df, trials_df, patients_df):
    """Display complete income realization analysis"""
    # Main dashboard
    display_income_realization_dashboard(visits_df, trials_df, patients_df)
    
    st.divider()
    
    # Detailed breakdowns in columns
    col1, col2 = st.columns(2)
    
    with col1:
        display_monthly_realization_breakdown(visits_df, trials_df)
        st.write("")
        display_study_pipeline_ranking(visits_df, trials_df)
    
    with col2:
        display_site_realization_comparison(visits_df, trials_df)
        st.write("")
        display_financial_year_summary(visits_df, trials_df, patients_df)
