import streamlit as st
import pandas as pd
import io
from formatters import (
    apply_currency_formatting, apply_currency_or_empty_formatting,
    create_fy_highlighting_function, format_dataframe_index_as_string,
    format_currency, clean_numeric_for_display, apply_conditional_formatting
)

def create_pivot_income_table(financial_df, group_cols, period_col, value_col='Payment'):
    """Create a pivot table for income analysis"""
    if financial_df.empty:
        return None, None
    
    income_by_period = financial_df.groupby(group_cols)[value_col].sum().reset_index()
    if income_by_period.empty:
        return None, None
    
    pivot = income_by_period.pivot(index=period_col, columns='SiteofVisit', values=value_col).fillna(0)
    pivot['Total'] = pivot.sum(axis=1)
    
    return pivot, income_by_period

def create_financial_year_totals(financial_df, site_columns):
    """Create financial year totals for income data"""
    fy_totals = []
    for fy in sorted(financial_df['FinancialYear'].unique()):
        fy_data = financial_df[financial_df['FinancialYear'] == fy]
        fy_income_by_site = fy_data.groupby('SiteofVisit')['Payment'].sum()
        
        fy_row = {}
        for site in site_columns:
            if site == 'Total':
                fy_row[site] = fy_income_by_site.sum()
            else:
                fy_row[site] = fy_income_by_site.get(site, 0)
        
        fy_totals.append((f"FY {fy}", fy_row))
    
    return fy_totals

def display_income_table_pair(financial_df):
    """Display monthly and quarterly income tables side by side"""
    # Monthly analysis
    monthly_pivot, _ = create_pivot_income_table(
        financial_df, ['SiteofVisit', 'MonthYear'], 'MonthYear'
    )
    
    # Quarterly analysis
    quarterly_pivot, _ = create_pivot_income_table(
        financial_df, ['SiteofVisit', 'QuarterYear'], 'QuarterYear'
    )
    
    if monthly_pivot is not None and quarterly_pivot is not None:
        # Create financial year totals
        fy_monthly_totals = create_financial_year_totals(financial_df, monthly_pivot.columns)
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.write("**Monthly Income by Visit Site**")
            monthly_display = format_dataframe_index_as_string(monthly_pivot)
            monthly_display = apply_currency_formatting(monthly_display, monthly_display.columns)
            st.dataframe(monthly_display, use_container_width=True)
            
            # Financial year totals for monthly
            if fy_monthly_totals:
                st.write("**Financial Year Totals (Monthly)**")
                display_fy_totals_table(fy_monthly_totals)
        
        with col2:
            st.write("**Quarterly Income by Visit Site**")
            quarterly_display = apply_currency_formatting(quarterly_pivot, quarterly_pivot.columns)
            st.dataframe(quarterly_display, use_container_width=True)

def display_fy_totals_table(fy_totals):
    """Display financial year totals table"""
    fy_data = []
    for fy_name, fy_row in fy_totals:
        formatted_row = {"Financial Year": fy_name}
        for col, val in fy_row.items():
            formatted_row[col] = format_currency(val)
        fy_data.append(formatted_row)
    
    fy_df = pd.DataFrame(fy_data)
    st.dataframe(fy_df, use_container_width=True)

def create_styled_dataframe(df, highlight_column=None, highlight_value=None):
    """Create a styled dataframe with optional highlighting"""
    if highlight_column and highlight_value:
        style_dict = {"bg_color": "#e6f3ff", "weight": "bold"}
        return apply_conditional_formatting(df, highlight_column, highlight_value, style_dict)
    return df

def display_profit_sharing_table(quarterly_ratios):
    """Display the main profit sharing analysis table"""
    if not quarterly_ratios:
        st.warning("No quarterly data available for analysis.")
        return
    
    quarterly_df = pd.DataFrame(quarterly_ratios)
    
    # Style to highlight financial year rows
    highlight_function = create_fy_highlighting_function()
    styled_df = quarterly_df.style.apply(highlight_function, axis=1)
    
    st.write("**Quarterly Profit Sharing Analysis**")
    st.dataframe(styled_df, use_container_width=True)

def display_ratio_breakdown_table(ratio_data, title):
    """Display a ratio breakdown table"""
    if not ratio_data:
        return
    
    st.write(f"**{title}**")
    ratio_df = pd.DataFrame(ratio_data)
    st.dataframe(ratio_df, use_container_width=True)

def create_summary_metrics_row(data_dict, columns=4):
    """Create a row of metric displays"""
    cols = st.columns(columns)
    
    for i, (label, value) in enumerate(data_dict.items()):
        with cols[i % columns]:
            st.metric(label, value)

def display_breakdown_by_study(df, patient_df, site):
    """Display study breakdown for a specific site"""
    site_patients = patient_df[patient_df['Site'] == site]
    site_visits = df[df['SiteofVisit'] == site]
    
    if site_patients.empty:
        return
    
    # Study breakdown
    study_breakdown = site_patients.groupby('Study').agg({
        'PatientID': 'count'
    }).rename(columns={'PatientID': 'Patient Count'})
    
    # Add visit counts and income
    visit_breakdown = site_visits.groupby('Study').agg({
        'Visit': 'count',
        'Payment': 'sum'
    }).rename(columns={'Visit': 'Visit Count', 'Payment': 'Total Income'})
    
    # Combine data
    combined_breakdown = study_breakdown.join(visit_breakdown, how='left').fillna(0)
    combined_breakdown = apply_currency_formatting(combined_breakdown, ['Total Income'])
    
    st.dataframe(combined_breakdown, use_container_width=True)

def create_time_period_config():
    """Configuration for different time periods"""
    return {
        'monthly': {
            'column': 'MonthYear',
            'name': 'Month',
            'title': 'Monthly Ratio Breakdowns'
        },
        'quarterly': {
            'column': 'QuarterYear', 
            'name': 'Quarter',
            'title': 'Quarterly Ratio Breakdowns'
        },
        'financial_year': {
            'column': 'FinancialYear',
            'name': 'Financial Year', 
            'title': 'Financial Year Ratio Breakdowns'
        }
    }

def display_site_time_analysis(visits_df, patients_df, site, enhanced_visits_df):
    """Display time-based analysis for a specific site"""
    st.write("**Quarterly Analysis**")
    
    # Filter for financial visits only
    financial_site_visits = enhanced_visits_df[enhanced_visits_df['SiteofVisit'] == site]
    
    if not financial_site_visits.empty:
        # Quarterly stats
        quarterly_stats = financial_site_visits.groupby('QuarterYear').agg({
            'Visit': 'count',
            'Payment': 'sum'
        }).rename(columns={'Visit': 'Visit Count', 'Payment': 'Income'})
        
        # Financial year stats  
        fy_stats = financial_site_visits.groupby('FinancialYear').agg({
            'Visit': 'count',
            'Payment': 'sum'
        }).rename(columns={'Visit': 'Visit Count', 'Payment': 'Income'})
        
        if not quarterly_stats.empty:
            col1, col2 = st.columns(2)
            
            with col1:
                st.write("*Visit Counts by Quarter*")
                st.dataframe(quarterly_stats[['Visit Count']], use_container_width=True)
            
            with col2:
                quarterly_display = apply_currency_formatting(quarterly_stats[['Income']], ['Income'])
                st.write("*Income by Quarter*")
                st.dataframe(quarterly_display, use_container_width=True)
        
        st.write("**Financial Year Analysis**")
        
        if not fy_stats.empty:
            col1, col2 = st.columns(2)
            
            with col1:
                st.write("*Visit Counts by Financial Year*")
                st.dataframe(fy_stats[['Visit Count']], use_container_width=True)
            
            with col2:
                fy_display = apply_currency_formatting(fy_stats[['Income']], ['Income'])
                st.write("*Income by Financial Year*")
                st.dataframe(fy_display, use_container_width=True)

def display_enhanced_site_statistics(visits_df, patients_df, unique_sites, screen_failures, enhanced_visits_df):
    """Display enhanced site-wise statistics with quarterly and FY analysis"""
    if visits_df.empty or patients_df.empty:
        return
    
    st.subheader("ðŸ“Š Site-wise Analysis")
    
    # Create tabs for each site or display directly if single site
    if len(unique_sites) > 1:
        tabs = st.tabs(unique_sites)
        for i, site in enumerate(unique_sites):
            with tabs[i]:
                display_single_enhanced_site_stats(visits_df, patients_df, enhanced_visits_df, site, screen_failures)
    else:
        display_single_enhanced_site_stats(visits_df, patients_df, enhanced_visits_df, unique_sites[0], screen_failures)

def display_single_enhanced_site_stats(visits_df, patients_df, enhanced_visits_df, site, screen_failures):
    """Display enhanced statistics for a single site"""
    site_patients = patients_df[patients_df['Site'] == site]
    site_visits = visits_df[visits_df['SiteofVisit'] == site]
    
    if site_patients.empty:
        st.warning(f"No patients found for site: {site}")
        return
    
    st.subheader(f"ðŸ“ {site} - Detailed Analysis")
    
    # Overall statistics
    st.write("**Overall Statistics**")
    metrics_data = {
        "Total Patients": len(site_patients),
        "Total Visits": len(site_visits),
        "Completed Visits": len(site_visits[site_visits.get('IsActual', False)]),
        "Total Income": format_currency(site_visits['Payment'].sum())
    }
    create_summary_metrics_row(metrics_data, 4)
    
    # Study breakdown
    st.write("**Studies at this site:**")
    display_breakdown_by_study(site_visits, site_patients, site)
    
    # Time-based analysis
    display_site_time_analysis(visits_df, patients_df, site, enhanced_visits_df)
    
    # Patient recruitment analysis
    display_site_recruitment_analysis(site_patients, enhanced_visits_df, site)
    
    # Screen failures
    display_site_screen_failures(site_patients, screen_failures)

def display_site_recruitment_analysis(site_patients, enhanced_visits_df, site):
    """Display patient recruitment analysis for a site"""
    st.write("**Patient Recruitment Analysis**")
    
    # Add time period columns to patients
    site_patients_enhanced = site_patients.copy()
    site_patients_enhanced['Quarter'] = site_patients_enhanced['StartDate'].dt.quarter
    site_patients_enhanced['Year'] = site_patients_enhanced['StartDate'].dt.year
    site_patients_enhanced['QuarterYear'] = site_patients_enhanced['Year'].astype(str) + '-Q' + site_patients_enhanced['Quarter'].astype(str)
    site_patients_enhanced['FinancialYear'] = site_patients_enhanced['StartDate'].apply(
        lambda d: f"{d.year}-{d.year+1}" if d.month >= 4 else f"{d.year-1}-{d.year}"
    )
    
    # Recruitment summaries
    quarterly_recruitment = site_patients_enhanced.groupby('QuarterYear')['PatientID'].count()
    fy_recruitment = site_patients_enhanced.groupby('FinancialYear')['PatientID'].count()
    
    if not quarterly_recruitment.empty or not fy_recruitment.empty:
        col1, col2 = st.columns(2)
        
        with col1:
            if not quarterly_recruitment.empty:
                st.write("*Patients Recruited by Quarter*")
                quarterly_df = quarterly_recruitment.to_frame()
                quarterly_df.columns = ['Patients Recruited']
                st.dataframe(quarterly_df, use_container_width=True)
        
        with col2:
            if not fy_recruitment.empty:
                st.write("*Patients Recruited by Financial Year*")
                fy_df = fy_recruitment.to_frame()
                fy_df.columns = ['Patients Recruited']
                st.dataframe(fy_df, use_container_width=True)
    
    # Combined summary tables
    display_site_summary_tables(site_patients_enhanced, enhanced_visits_df, site, quarterly_recruitment, fy_recruitment)

def display_site_summary_tables(site_patients, enhanced_visits_df, site, quarterly_recruitment, fy_recruitment):
    """Display combined summary tables for a site"""
    site_enhanced_visits = enhanced_visits_df[enhanced_visits_df['SiteofVisit'] == site]
    
    # Quarterly summary
    st.write("**Quarterly Summary Table**")
    quarterly_summary = build_period_summary(
        site_enhanced_visits, quarterly_recruitment, 'QuarterYear', 'Quarter'
    )
    if quarterly_summary:
        st.dataframe(pd.DataFrame(quarterly_summary), use_container_width=True)
    
    # Financial year summary  
    st.write("**Financial Year Summary Table**")
    fy_summary = build_period_summary(
        site_enhanced_visits, fy_recruitment, 'FinancialYear', 'Financial Year'
    )
    if fy_summary:
        st.dataframe(pd.DataFrame(fy_summary), use_container_width=True)

def build_period_summary(visits_df, recruitment_series, period_col, period_name):
    """Build summary data for a time period"""
    if visits_df.empty:
        return []
    
    visit_stats = visits_df.groupby(period_col).agg({'Visit': 'count', 'Payment': 'sum'})
    all_periods = set(visit_stats.index) | set(recruitment_series.index)
    
    summary_data = []
    for period in sorted(all_periods):
        visits = visit_stats.loc[period, 'Visit'] if period in visit_stats.index else 0
        income = visit_stats.loc[period, 'Payment'] if period in visit_stats.index else 0
        patients = recruitment_series.loc[period] if period in recruitment_series.index else 0
        
        summary_data.append({
            period_name: period if period_name == 'Quarter' else period,
            'Patients Recruited': clean_numeric_for_display(patients),
            'Visits Completed': clean_numeric_for_display(visits),
            'Income': format_currency(income)
        })
    
    return summary_data

def display_site_screen_failures(site_patients, screen_failures):
    """Display screen failures for a site"""
    site_screen_failures = []
    for patient in site_patients.itertuples():
        patient_study_key = f"{patient.PatientID}_{patient.Study}"
        if patient_study_key in screen_failures:
            site_screen_failures.append({
                'Patient': patient.PatientID,
                'Study': patient.Study,
                'Screen Fail Date': screen_failures[patient_study_key].strftime('%Y-%m-%d')
            })
    
    if site_screen_failures:
        st.write("**Screen Failures**")
        st.dataframe(pd.DataFrame(site_screen_failures), use_container_width=True)

def create_excel_export_data(calendar_df, site_column_mapping, unique_sites):
    """Prepare data for Excel export with proper formatting"""
    # Get ordered columns
    final_ordered_columns = ["Date", "Day"]
    for site in unique_sites:
        site_columns = site_column_mapping.get(site, [])
        for col in site_columns:
            if col in calendar_df.columns:
                final_ordered_columns.append(col)

    # Add financial columns
    excel_financial_cols = ["Daily Total", "Monthly Total", "FY Total"] + [c for c in calendar_df.columns if "Income" in c]
    all_columns = final_ordered_columns + [col for col in excel_financial_cols if col in calendar_df.columns]
    
    excel_df = calendar_df[all_columns].copy()
    
    # Format dates and currency
    excel_df["Date"] = excel_df["Date"].dt.strftime("%d/%m/%Y")
    excel_df = apply_currency_or_empty_formatting(excel_df, ["Monthly Total", "FY Total"])
    excel_df = apply_currency_formatting(excel_df, [col for col in excel_financial_cols if col not in ["Monthly Total", "FY Total"] and col in excel_df.columns])
    
    return excel_df

def apply_excel_formatting(ws, excel_df, site_column_mapping, unique_sites):
    """Apply formatting to Excel worksheet"""
    try:
        from openpyxl.styles import PatternFill, Font, Alignment
        from openpyxl.utils import get_column_letter
        
        # Add site headers
        for col_idx, col_name in enumerate(excel_df.columns, 1):
            col_letter = get_column_letter(col_idx)
            if col_name not in ["Date", "Day"] and not any(x in col_name for x in ["Income", "Total"]):
                for site in unique_sites:
                    if col_name in site_column_mapping.get(site, []):
                        ws[f"{col_letter}1"] = site
                        ws[f"{col_letter}1"].font = Font(bold=True, size=12)
                        ws[f"{col_letter}1"].fill = PatternFill(start_color="FFE6F3FF", end_color="FFE6F3FF", fill_type="solid")
                        ws[f"{col_letter}1"].alignment = Alignment(horizontal="center")
                        break

        # Auto-adjust column widths
        for idx, col in enumerate(excel_df.columns, 1):
            col_letter = get_column_letter(idx)
            max_length = max([len(str(cell)) if cell is not None else 0 for cell in excel_df[col].tolist()] + [len(col)])
            ws.column_dimensions[col_letter].width = max(10, max_length + 2)
    except ImportError:
        # If openpyxl styles not available, skip formatting
        pass

def display_generic_analysis_table(data, title, description=None):
    """Display a generic analysis table with optional description"""
    if not data:
        st.warning(f"No data available for {title.lower()}.")
        return
    
    st.write(f"**{title}**")
    if description:
        st.info(description)
    
    if isinstance(data, list):
        df = pd.DataFrame(data)
    else:
        df = data
    
    st.dataframe(df, use_container_width=True)

def create_comparison_table(data1, data2, labels, comparison_columns):
    """Create a side-by-side comparison table"""
    col1, col2 = st.columns(2)
    
    with col1:
        st.write(f"**{labels[0]}**")
        if data1 is not None and not data1.empty:
            display_df1 = apply_currency_formatting(data1, comparison_columns)
            st.dataframe(display_df1, use_container_width=True)
        else:
            st.write("No data available")
    
    with col2:
        st.write(f"**{labels[1]}**")
        if data2 is not None and not data2.empty:
            display_df2 = apply_currency_formatting(data2, comparison_columns)
            st.dataframe(display_df2, use_container_width=True)
        else:
            st.write("No data available")
