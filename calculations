import pandas as pd
from datetime import date

def prepare_financial_data(visits_df):
    """Prepare visits data with financial period columns"""
    if visits_df.empty:
        return pd.DataFrame()
    
    # Filter for relevant visits (exclude tolerance periods)
    financial_df = visits_df[
        (visits_df['Visit'].str.startswith("✅")) |
        (visits_df['Visit'].str.startswith("❌ Screen Fail")) |
        (visits_df['Visit'].str.startswith("🔴")) |
        (visits_df['Visit'].str.contains('Visit', na=False) & (~visits_df.get('IsActual', False)))
    ].copy()

    if not financial_df.empty:
        # Add all time period columns
        financial_df['MonthYear'] = financial_df['Date'].dt.to_period('M')
        financial_df['Quarter'] = financial_df['Date'].dt.quarter
        financial_df['Year'] = financial_df['Date'].dt.year
        financial_df['QuarterYear'] = financial_df['Year'].astype(str) + '-Q' + financial_df['Quarter'].astype(str)
        financial_df['FinancialYear'] = financial_df['Date'].apply(
            lambda d: f"{d.year}-{d.year+1}" if d.month >= 4 else f"{d.year-1}-{d.year}"
        )
    
    return financial_df

def calculate_work_ratios(data_df, period_column, period_value):
    """Calculate work done ratios for a specific period"""
    period_data = data_df[data_df[period_column] == period_value]
    
    if len(period_data) == 0:
        return {
            'ashfields_work_ratio': 0,
            'kiltearn_work_ratio': 0,
            'total_work': 0
        }
    
    site_work = period_data.groupby('SiteofVisit').size()
    total_work = site_work.sum()
    
    return {
        'ashfields_work_ratio': site_work.get('Ashfields', 0) / total_work if total_work > 0 else 0,
        'kiltearn_work_ratio': site_work.get('Kiltearn', 0) / total_work if total_work > 0 else 0,
        'total_work': total_work,
        'ashfields_work_count': site_work.get('Ashfields', 0),
        'kiltearn_work_count': site_work.get('Kiltearn', 0)
    }

def calculate_recruitment_ratios(patients_df, period_column, period_value):
    """Calculate patient recruitment ratios for a specific period"""
    if period_column == 'MonthYear':
        period_patients = patients_df[patients_df['StartDate'].dt.to_period('M') == period_value]
    elif period_column == 'QuarterYear':
        period_patients = patients_df[patients_df['StartDate'].dt.to_period('Q').astype(str) == period_value.replace('-Q', 'Q')]
    elif period_column == 'FinancialYear':
        fy_start = pd.to_datetime(f"{period_value.split('-')[0]}-04-01")
        fy_end = pd.to_datetime(f"{period_value.split('-')[1]}-03-31")
        period_patients = patients_df[(patients_df['StartDate'] >= fy_start) & (patients_df['StartDate'] <= fy_end)]
    else:
        return {
            'ashfields_recruitment_ratio': 0,
            'kiltearn_recruitment_ratio': 0,
            'total_recruitment': 0
        }
    
    recruitment = period_patients.groupby('Site')['PatientID'].count()
    total_recruitment = recruitment.sum()
    
    return {
        'ashfields_recruitment_ratio': recruitment.get('Ashfields', 0) / total_recruitment if total_recruitment > 0 else 0,
        'kiltearn_recruitment_ratio': recruitment.get('Kiltearn', 0) / total_recruitment if total_recruitment > 0 else 0,
        'total_recruitment': total_recruitment,
        'ashfields_recruitment_count': recruitment.get('Ashfields', 0),
        'kiltearn_recruitment_count': recruitment.get('Kiltearn', 0)
    }

def calculate_combined_ratios(list_ratios, work_ratios, recruitment_ratios, weights):
    """Calculate final combined profit sharing ratios"""
    list_weight, work_weight, recruitment_weight = weights
    
    # Get list ratios
    ashfields_list_ratio = list_ratios['ashfields']
    kiltearn_list_ratio = list_ratios['kiltearn']
    
    # Calculate combined ratios
    ashfields_final = (ashfields_list_ratio * list_weight + 
                      work_ratios['ashfields_work_ratio'] * work_weight + 
                      recruitment_ratios['ashfields_recruitment_ratio'] * recruitment_weight)
    
    kiltearn_final = (kiltearn_list_ratio * list_weight + 
                     work_ratios['kiltearn_work_ratio'] * work_weight + 
                     recruitment_ratios['kiltearn_recruitment_ratio'] * recruitment_weight)
    
    # Normalize
    total_ratio = ashfields_final + kiltearn_final
    if total_ratio > 0:
        ashfields_final = ashfields_final / total_ratio
        kiltearn_final = kiltearn_final / total_ratio
    
    return {
        'ashfields_final_ratio': ashfields_final,
        'kiltearn_final_ratio': kiltearn_final
    }

def get_list_ratios():
    """Get fixed list size ratios"""
    ashfields_list_size = 28500
    kiltearn_list_size = 12500
    total_list_size = ashfields_list_size + kiltearn_list_size
    
    return {
        'ashfields': ashfields_list_size / total_list_size,
        'kiltearn': kiltearn_list_size / total_list_size,
        'ashfields_size': ashfields_list_size,
        'kiltearn_size': kiltearn_list_size
    }

def calculate_period_ratios(data_df, patients_df, period_column, period_value, weights):
    """Calculate all ratios for a specific period"""
    list_ratios = get_list_ratios()
    work_ratios = calculate_work_ratios(data_df, period_column, period_value)
    recruitment_ratios = calculate_recruitment_ratios(patients_df, period_column, period_value)
    combined_ratios = calculate_combined_ratios(list_ratios, work_ratios, recruitment_ratios, weights)
    
    return {
        'list': list_ratios,
        'work': work_ratios,
        'recruitment': recruitment_ratios,
        'combined': combined_ratios
    }

def build_profit_sharing_analysis(financial_df, patients_df, weights):
    """Build complete profit sharing analysis data"""
    quarters = sorted(financial_df['QuarterYear'].unique()) if 'QuarterYear' in financial_df.columns else []
    financial_years = sorted(financial_df['FinancialYear'].unique()) if 'FinancialYear' in financial_df.columns else []
    
    quarterly_ratios = []
    
    # Process quarters
    for quarter in quarters:
        quarter_data = financial_df[financial_df['QuarterYear'] == quarter]
        if len(quarter_data) == 0:
            continue
            
        ratios = calculate_period_ratios(financial_df, patients_df, 'QuarterYear', quarter, weights)
        
        # Calculate quarter income
        quarter_total_income = quarter_data['Payment'].sum()
        ashfields_income = quarter_total_income * ratios['combined']['ashfields_final_ratio']
        kiltearn_income = quarter_total_income * ratios['combined']['kiltearn_final_ratio']
        
        # Extract financial year for sorting
        year_part = int(quarter.split('-Q')[0])
        quarter_num = int(quarter.split('-Q')[1])
        fy_year = year_part if quarter_num >= 2 else year_part - 1
        
        quarterly_ratios.append({
            'Period': quarter,
            'Financial Year': fy_year,
            'Type': 'Quarter',
            'Total Visits': ratios['work']['total_work'],
            'Ashfields Visits': ratios['work']['ashfields_work_count'],
            'Kiltearn Visits': ratios['work']['kiltearn_work_count'],
            'Ashfields Patients': ratios['recruitment']['ashfields_recruitment_count'],
            'Kiltearn Patients': ratios['recruitment']['kiltearn_recruitment_count'],
            'Ashfields Share': f"{ratios['combined']['ashfields_final_ratio']:.1%}",
            'Kiltearn Share': f"{ratios['combined']['kiltearn_final_ratio']:.1%}",
            'Total Income': f"£{quarter_total_income:,.2f}",
            'Ashfields Income': f"£{ashfields_income:,.2f}",
            'Kiltearn Income': f"£{kiltearn_income:,.2f}"
        })
    
    # Process financial years
    for fy in financial_years:
        fy_data = financial_df[financial_df['FinancialYear'] == fy]
        if len(fy_data) == 0:
            continue
            
        ratios = calculate_period_ratios(financial_df, patients_df, 'FinancialYear', fy, weights)
        
        # Calculate financial year income
        fy_total_income = fy_data['Payment'].sum()
        ashfields_income = fy_total_income * ratios['combined']['ashfields_final_ratio']
        kiltearn_income = fy_total_income * ratios['combined']['kiltearn_final_ratio']
        
        quarterly_ratios.append({
            'Period': f"FY {fy}",
            'Financial Year': int(fy.split('-')[0]),
            'Type': 'Financial Year',
            'Total Visits': ratios['work']['total_work'],
            'Ashfields Visits': ratios['work']['ashfields_work_count'],
            'Kiltearn Visits': ratios['work']['kiltearn_work_count'],
            'Ashfields Patients': ratios['recruitment']['ashfields_recruitment_count'],
            'Kiltearn Patients': ratios['recruitment']['kiltearn_recruitment_count'],
            'Ashfields Share': f"{ratios['combined']['ashfields_final_ratio']:.1%}",
            'Kiltearn Share': f"{ratios['combined']['kiltearn_final_ratio']:.1%}",
            'Total Income': f"£{fy_total_income:,.2f}",
            'Ashfields Income': f"£{ashfields_income:,.2f}",
            'Kiltearn Income': f"£{kiltearn_income:,.2f}"
        })
    
    # Sort results
    quarterly_ratios.sort(key=lambda x: (x['Financial Year'], x['Type'] == 'Financial Year', x['Period']))
    
    return quarterly_ratios

def build_ratio_breakdown_data(financial_df, patients_df, period_config, weights):
    """Build ratio breakdown data for any time period"""
    period_column = period_config['column']
    period_name = period_config['name']
    
    if period_column == 'MonthYear':
        periods = sorted(financial_df['MonthYear'].unique()) if not financial_df.empty else []
    elif period_column == 'QuarterYear':
        periods = sorted(financial_df['QuarterYear'].unique()) if 'QuarterYear' in financial_df.columns else []
    elif period_column == 'FinancialYear':
        periods = sorted(financial_df['FinancialYear'].unique()) if 'FinancialYear' in financial_df.columns else []
    else:
        return []
    
    list_ratios = get_list_ratios()
    ratio_data = []
    
    for period in periods:
        ratios = calculate_period_ratios(financial_df, patients_df, period_column, period, weights)
        
        period_display = str(period) if period_column == 'MonthYear' else period
        if period_column == 'FinancialYear':
            period_display = f"FY {period}"
        
        ratio_data.append({
            f'{period_name}': period_display,
            'Ashfields List %': f"{ratios['list']['ashfields']:.1%}",
            'Kiltearn List %': f"{ratios['list']['kiltearn']:.1%}",
            'Ashfields Work %': f"{ratios['work']['ashfields_work_ratio']:.1%}",
            'Kiltearn Work %': f"{ratios['work']['kiltearn_work_ratio']:.1%}",
            'Ashfields Recruit %': f"{ratios['recruitment']['ashfields_recruitment_ratio']:.1%}",
            'Kiltearn Recruit %': f"{ratios['recruitment']['kiltearn_recruitment_ratio']:.1%}",
            'Ashfields Final %': f"{ratios['combined']['ashfields_final_ratio']:.1%}",
            'Kiltearn Final %': f"{ratios['combined']['kiltearn_final_ratio']:.1%}",
            'Total Visits': ratios['work']['total_work'],
            'Total Recruits': ratios['recruitment']['total_recruitment']
        })
    
    return ratio_data
